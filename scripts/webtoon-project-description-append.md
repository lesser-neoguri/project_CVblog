## 10. 데모 구현과 시행착오

이 프로젝트에는 실제로 동작하는 **웹 데모**가 포함되어 있다. 프로젝트 상세 페이지에서 LIVE DEMO로 `/demo/webtoon-chatbot`이 iframe 임베드되며, 아래 기능들이 구현되어 있다. 구현 과정에서 겪은 시행착오와 수정 사항을 정리한다.

### 10.1 데모 구성

* **채팅 UI**: 사용자/봇 말풍선, 입력창, 전송. RAG·커스텀 설정을 반영한 시스템 프롬프트로 LLM이 답변 생성.
* **RAG 커스텀 패널**: 세계관, 성격, 말투/톤, **대화 시점**, **대화 패턴**을 입력할 수 있다. 입력 시 시스템 프롬프트에 [캐릭터 설정] 및 `### 대화 시점 ###`, `### 대화 패턴 ###` 블록으로 주입된다.
* **대화 시점·대화 패턴**: [NAVER Cloud 포스트](https://www.ncloud-forums.com/topic/382/) (HyperCLOVA X로 2시간 만에 캐릭터 챗봇 만들기)를 참고해, "현재 스토리상 어느 시점의 캐릭터인지"와 "등장인물 언급·존칭·반말/존댓말·감정·이모티콘·특정 어휘" 등 구체적 행동 규칙을 넣을 수 있게 했다.
* **API / 목업 토글**: 실제 API 호출과 키워드 기반 목업 응답을 헤더에서 전환할 수 있다. API 키가 없거나 오류 시에도 데모를 체험할 수 있도록 했다.

### 10.2 API 사용 여부가 구분되지 않던 문제

* **상황**: UI에는 "실제 API 사용 중"으로 나오는데, 응답은 전부 목업처럼 보이고 뱃지도 없어 사용자가 "API 사용이 안 되고 있다"고 느낌.
* **원인**: API 키가 없거나 서버 오류 시 **폴백으로 목업**을 쓰는데, 그때 사용자에게 **실패 사유를 알려주지 않음**. 또한 메시지별로 "이 답은 API인지 목업인지" 표시가 없어서 구분이 불가능했다.
* **수정**:
  * API 호출 실패 시(특히 503 useFallback)에도 **에러 메시지를 저장해 입력창 아래에 표시**. "API 사용 불가" 박스에 서버 메시지(예: API 키를 .env.local에 설정해 주세요)와 함께 .env.local 설정 안내를 넣었다.
  * **메시지별 출처 뱃지**: 봇 메시지에 "API" 또는 "목업" 뱃지를 붙여, 실제로 어떤 경로로 생성된 답인지 보이게 했다.
  * 헤더에 "지금: 실제 API 사용 중 / 목업 사용 중" 문구와, API 모드일 때 "(.env.local에 OPENAI_API_KEY 또는 UPSTAGE_API_KEY 필요)" 안내를 추가했다.

### 10.3 Upstage API 연동 시행착오

* **상황**: UPSTAGE_API_KEY를 넣었는데 **400 The requested model is invalid or no longer supported** 오류 발생.
* **원인 후보**:
  * 사용하던 **모델명** `solar-pro-3`가 해당 엔드포인트에서 지원되지 않거나 변경됨.
  * **Base URL** 차이: v1/solar vs v2 문서가 혼재해 있어, 엔드포인트·모델 ID 조합이 맞지 않을 수 있음.
* **수정**:
  * **Base URL**: `https://api.upstage.ai/v1/solar` 로 통일. (Upstage EduStage·Mastra 문서에서 v1/solar 사용 예시가 있음.) 환경 변수 `UPSTAGE_BASE_URL`로 덮을 수 있게 했다.
  * **모델명**: EduStage 가이드 기준으로 **`solar-mini`** (접두사 없음)를 기본값으로 사용. `UPSTAGE_CHAT_MODEL`로 변경 가능. (v2 사용 시 `upstage/solar-mini` 등 콘솔 문서의 모델 ID 사용.)
  * 데모 화면의 API 오류 안내에 "Upstage 사용 시 모델 오류(400)가 나면 UPSTAGE_CHAT_MODEL=solar-mini, UPSTAGE_BASE_URL=https://api.upstage.ai/v1/solar 를 추가해 보세요" 문구를 넣었다.

### 10.4 정리

* 데모는 **API 키 없이도 목업으로 동작**하고, API 키가 있으면 **실제 LLM + RAG**가 동작한다. API/목업 전환과 메시지별 뱃지로 어떤 경로로 응답했는지 명확히 보이도록 했다.
* Upstage를 쓸 때는 **콘솔 문서(모델 목록·Chat API)**를 확인해, 사용 중인 base URL과 모델 ID가 일치하는지 점검하는 것이 좋다.
